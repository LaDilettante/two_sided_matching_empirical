\chapter{Two-Sided Matching Model}
\label{chap:model}

Here I present a behavioral model of the two-sided matching market, focusing on
the case of many-to-one matching, first proposed by \cite{Logan1996}. For easier exposition, throughout the chapter
I will use the example of the labor market, where many workers can be matched to
one firm, to demonstrate the features of this model.

In this model, there are two separate sets of actors: firms and workers. There
are two sub-components of the model, happening sequentially. In the first stage, each firm
evaluates each worker in the sample, then decide whether to extend an offer or
not. In the second stage, 

meaning that the model rests on the behavioral assumption that
people make choices by maximizing their utilities. The parameters estimated will
be the preference of people, and can be interpreted as how much they value
different features. Since utility is unit-less, it won't have a scale, we only
care about the relative values of different parameters.
Cite McFadden here

- one sided model won't be able to distinguish the effect between preference and opportunity
- follows the tradition of discrete choice, in which actors choose from a set of
finite and discrete alternatives (firms choosing from workers, workers choosing
offers). Here we do make the assumption that the sample is representative of the
population, i.e. the workers in the sample are also the workers that are
presented to firm

This section describes the two-sided matching model, a behavioral model in the
sense that actors which is the
behavioincluding the utilities of countries' officials and of MNCs. Then, the matching process is a natural consequence of actors' choosing the best option available to them.

This model is a parametric version of the matching game by Roth 


IIA the ratio of the probabilities of choosing between two alternatives is
independent of the attributes of all other alternatives. (This applies to the
worker side).

We assume that the matching process in the labor market happens in two stage.
In the first stage, each firm evaluates each worker in the sample, then
decide whether to hire that worker or not. At the end of this stage, each worker
has a set of offers from firms, which we call his \textit{opportunity
  set}. In the second stage, each worker evaluates the firms in his
opportunity set and chooses the firm that he likes best. This constitutes a
final, observed match between a worker and a firm. This is a many-to-one
matching problem because a firm can make offers to multiple
workers, none, some, or all of which can be accepted by workers.

If we assume that firms and workers are utility-maximizing agents, at the end of
this process, no firm or worker would voluntarily change their final matches.
This property is called \textit{stability} in the game theoretic two-sided
matching literature. We want the model to have this property because real life
matching market tends to be stable as well. Indeed, \citep{Roth1992} show that
for any given set of preferences, a stable match always exist. Furthermore,
\citep{Roth2016} and \citep{Adachi2003} show that a decentralized market with
agents making independent, utility-maximizing decisions can also reach a stable
match by itself.

This stability property does not implies that the matches will not change.
Indeed, if actors' preference shift, their characteristics change, or new actors
enter the market, the matches will also change as a result of actors'
recalculating their utility and adjust their decisions. Therefore, since we are
estimating the actors' preference using only a snapshot of matching market, we
are making the assumption that on a systemic level, the average characteristics of the
actors and their preference remain sufficiently static for our estimates to be meaningful.

\subsection{The decision making of firms}

A firm $j$'s decision on whether to hire worker $i$ rests on two utility
functions. First, firm $j$'s utility for hiring worker $i$ is:

\begin{align}
U_j(i) &= \bm{\beta}_j' X_i + \epsilon_{1ij}
\end{align}

where

\begin{align*}
\beta_j &\text{ is a vector of firm $j$'s preference for worker characteristics} \\
x_i &\text{ is a vector of worker $i$'s measured values on those characteristics} \\
\epsilon_{1ij} &\text{ is the unobserved component that influences firm $j$'s utility}
\end{align*}

On the other hand, the utility of not hiring worker $i$ is:

\begin{align}
U_j(\neg i) &= b_j + \epsilon_{0ij}
\end{align}

where

\begin{align*}
b_j &\text{ is the baseline utility of firm $j$} \\
\epsilon_{0ij} &\text{ is the unobserved component that influences firm $j$'s utility}
\end{align*}

For each worker $i$, firm $j$ will make an offer to hire if $U_j(i) > U_j(\neg
i)$. Relevant worker characteristics (i.e. $X_i$) that a firm may consider are
age, education, or experience. The corresponding $\beta$'s represent the firm's
preference for these characteristics.

This model makes two important assumptions about firms' hiring process. First, a
firm's decision to hire worker A depends on the characteristics of worker A
alone, and it will continue to hire worker A even if worker B is not available.
In other words, firms regard workers as substitutes rather than complements.\footnote{In the terminology of \citep{Roth1992}, this assumption means
  that firms' preference has the property of substitutability, or that firms
  have substitutable preference.} This assumption is not universally true. A
Hollywood producer may need to hire two specific lead actors for their
complementary chemistry, and if one is unavailable, the other also has to be
replaced. However, for large firms where workers are closer to
swappable cogs than unique superstars, this assumption is more reasonable.


Assumption: substitutability, and no decreasing marginal return to productivity

We make several assumptions that are standard in the discrete choice literature.
First, we assume a linear utility function. Second, we assume that the error
terms $\epsilon_{1ij}, \epsilon_{0ij}$ are uncorrelated. This assumption is most
likely not true: unobserved factors in one firm's utility are likely to share
some components with unobserved factors in another firm's utility, and thus
correlated. The hope is that we have modeled the observed portion of firm's
utility sufficiently well that the remaining unobserved factors are close to
white noise. In any case, this issue afflicts any application of discrete choice
models and is not unique to our case.\footnote{The discrete choice model has
  developed solutions for correlated error structure, such as nested logit,
  probit, and mixed logit, that can be applied here if we suspect that firms'
  unobserved utility is strong correlated.} 

Third, we assume that the as error terms $\epsilon_{1ij}, \epsilon_{0ij}$ follow
the Gumbel distribution, which has a slightly fatter tail the normal
distribution allowing for slightly more extreme variation in the unobserved
utility. In practice, the difference between using Gumbel and independent normal
error terms is small \citep{Train2009}. The choice of the Gumbel distribution is largely motivated by its
convenience since we can derive the probability of firm $j$ making an offer to worker $i$ as the familiar binomial logit form:

Also discuss IIA here

\begin{align}
Pr(o_{ij} = 1) &= Pr(U_j(i) > U_j(\neg i)) \\
&= Pr(\epsilon_{0ij} - \epsilon_{1ij} <  \bm{\beta}_j ' X_i - b_j) \\
&= \frac{\exp({\bm{\beta}_j'X_i})}{1 + \exp({\bm{\beta}_j'X_i})} \label{eq:prob_offer_ij}
\end{align}

\begin{align}
p(O_i | \bm{\beta}) &= \prod_{j \in O_i} p(o_{ij} = 1 | \bm{\beta}) \prod_{j \notin O_i} p(o_{ij} = 0 | \bm{\beta}) \\
&= \prod_{j \in O_i} \frac{\exp(\bm{\beta_j} ' X_i)}{1 + \exp(\bm{\beta_j}' X_i)}
 \prod_{j \notin O_i} \frac{1}{1 + \exp(\bm{\beta_j}' X_i)} \label{eq:conditional_probability_of_offer}
\end{align}

In our observed data, since we only observe the final matching of firms and countries, this opportunity set is unobserved. As will discuss, we use the Metropolis-Hastings algorithm to approximate the posterior distribution of the opportunity set.

\subsection{Firms' utility}

On the other side, for firm $i$, the utility of investing in country $j$ is:

\begin{align}
V_i(j) &= \alpha' W_{j} + v_{ij}
\end{align}

where

\begin{align*}
\alpha &\text{ is a vector of firms' preference for relevant characteristics of countries} \\
W_j &\text{ is a vector of country $j$ measured values on those characteristics} \\
v_{ij} &\text{ is the unobserved component that influences firm $i$'s utility}
\end{align*}

Firm $i$ evaluates all the countries that welcome it to invest and chooses the country that brings the highest utility. This choice of firms concludes the matching process, resulting in the observed final match between a firm and a country in our data.

In our model, relevant country characteristics can be: labor quality, level of development, and market size. Since all firms are considered having homogeneous preferences, $\alpha$ does not have a subscript $i$. The model can be easily extended so that there is heterogeneous preference among firms.

If $v_{ij}$ is modeled as having a Gumbel distribution, then the probability that firm $i$ will accept the offer of official $j$ out of all the offers in its opportunity set $O_i$ takes the multinomial logit form \citep{Cameron2005}:

\begin{align}
p(A_i = a_i | O_i, \alpha_i) = \frac{\exp(\alpha'W_{a_i})}{\sum\limits_{j:j \in O_i} \exp(\alpha'W_j)} \label{eq:conditional_probability_of_accept}
\end{align}

\section{Model Estimation}

Because the opportunity set is unobserved, we have to use MCMC to estimate it.

\begin{align}
U_j(i) &= \bm{\beta}_j' X_i + \epsilon_{1ij}
U_j(\neg i) &= b_j + \epsilon_{0ij}
V_i(j) &= \alpha' W_{j} + v_{ij}
\end{align}

\begin{align}
Pr(o_{ij} = 1) &= Pr(U_j(i) > U_j(\neg i)) \\
&= Pr(\epsilon_{0ij} - \epsilon_{1ij} <  \bm{\beta}_j ' X_i - b_j) \\
&= \frac{\exp({\bm{\beta}_j'X_i})}{1 + \exp({\bm{\beta}_j'X_i})} \label{eq:prob_offer_ij}
\end{align}

\begin{align}
p(O_i | \bm{\beta}) &= \prod_{j \in O_i} p(o_{ij} = 1 | \bm{\beta}) \prod_{j \notin O_i} p(o_{ij} = 0 | \bm{\beta}) \\
&= \prod_{j \in O_i} \frac{\exp(\bm{\beta_j} ' X_i)}{1 + \exp(\bm{\beta_j}' X_i)}
 \prod_{j \notin O_i} \frac{1}{1 + \exp(\bm{\beta_j}' X_i)} \label{eq:conditional_probability_of_offer}
\end{align}

\begin{align}
p(A_i = a_i | O_i, \alpha_i) = \frac{\exp(\alpha'W_{a_i})}{\sum\limits_{j:j \in O_i} \exp(\alpha'W_j)} \label{eq:conditional_probability_of_accept}
\end{align}

Joint likelihood:

\begin{align}
p(O, A, \alpha, \beta, \mu_{\beta}, \tau_{\beta}) &= p(A|O, \alpha) p(O|\beta) p(\alpha) p(\beta|\mu_{\beta}, \tau_{\beta}) p(\mu_{\beta}) p(\tau_{\beta}) 
\end{align}

\subsection{Updating the opportunity set}

Target distribution for a firm $i$ 

\begin{align}
p(O_i | A_i, \alpha, \bm{\beta}) &= \frac{p(O_i, A_i, \alpha, \bm{\beta})}{p(A_i, \alpha, \bm{\beta})}
\end{align}

\begin{align}
MH_O = \frac{p(O_i^* | A_i, \alpha, \bm{\beta})}{p(O_i | A_i, \alpha, \bm{\beta})} &= \frac{p(O_i^*, A_i, \alpha, \bm{\beta})}{p(A_i, \alpha, \bm{\beta})} \times \frac{p(A_i, \alpha, \bm{\beta})}{p(O_i, A_i, \alpha, \bm{\beta})} \\
&= \frac{p(O_i^*, A_i, \alpha, \bm{\beta})}{p(O_i, A_i, \alpha, \bm{\beta})} \\
&= \frac{p(A_i | O_i^*, \alpha)p(O_i^*|\bm{\beta})}{p(A_i | O_i, \alpha)p(O_i|\bm{\beta})} \label{eq:updateO_joint_dist_into_conditional_dist} \\
\end{align}

where the factorization of the likelihood in \eqref{eq:updateO_joint_dist_into_conditional_dist} is due to the fact that the acceptance of firm $i$ only depends on what is offered to it and what is its preference, $p(A_i | O_i^*, \alpha)$; what is offered to $i$ depends on the preferences of all countries, $p(O_i^* | \bm{\beta})$.

If we plug in \eqref{eq:conditional_probability_of_accept} and \eqref{eq:conditional_probability_of_offer}

\begin{align}
\frac{p(O_i^* | A_i, \alpha, \bm{\beta})}{p(O_i | A_i, \alpha, \bm{\beta})} &= \frac{\sum\limits_{j:j \in O_i} \exp(\alpha'W_j)}{\sum\limits_{j:j \in O_i} \exp(\alpha'W_j) + \exp(\alpha' W_{j^*})} \times \exp(\bm{\beta}_{j^*}'X_i)
\end{align}

where $j^*$ is the index of the newly sampled job. This is the case when the newly proposed job is not already offered, so it's added to the opportunity set.

When the newly proposed job is already offered, so it's removed from the opportunity set, we have

\begin{align}
\frac{p(O_i^* | A_i, \alpha, \bm{\beta})}{p(O_i | A_i, \alpha, \bm{\beta})} &= \frac{\sum\limits_{j:j \in O_i} \exp(\alpha'W_j)}{\sum\limits_{j:j \in O_i} \exp(\alpha'W_j) - \exp(\alpha' W_{j^*})} \times \exp(- \bm{\beta}_{j^*}'X_i)
\end{align}

\subsection{Updating firms' parameters, $\alpha$}

Target distribution:

\begin{align}
p(\alpha | A, O, \bm{\beta}) &= \frac{p(O, A, \alpha, \bm{\beta})}{p(A, O, \bm{\beta})}
\end{align}

We propose a new $\alpha^*$ using a symmetric proposal distribution that sample $\alpha^*$ in a box whose boundary is $\alpha^* \pm \epsilon_\alpha$

Metropolis-Hasting acceptance ratio:

\begin{align}
MH_\alpha = \frac{p(\alpha^* | A, O, \bm{\beta})}{p(\alpha | A, O, \bm{\beta})} &= \frac{p(A_i | O_i, \alpha^*)p(O_i|\bm{\beta})}{p(A_i | O_i, \alpha)p(O_i|\bm{\beta})} \\
&= \frac{p(A_i | O_i, \alpha^*)}{p(A_i | O_i, \alpha)} \label{eq:updatealpha_MHratio_final}
\end{align}

where \eqref{eq:updatealpha_MHratio_final} is due to the flat prior (so $\frac{p(\alpha^*)}{p(\alpha)}=1$) and the symmetric proposal distribution (so $\frac{p(\alpha^*|\alpha)}{p(\alpha|\alpha^*)} = 1$)

If we plug in \eqref{eq:conditional_probability_of_accept},

\begin{align}
MH_\alpha &= \prod_i \left[ \frac{\exp(\alpha^{*\prime} W_{a_i})}{\exp(\alpha' W_{a_i})} \times \frac{\sum\limits_{j:j \in O_i} \exp(\alpha' W_j)}{\sum\limits_{j:j \in O_i} \exp(\alpha^{*\prime}W_j)} \right] \\
&= \prod_i \left[ \exp(\epsilon_\alpha ' W_{a_i}) \times \frac{\sum\limits_{j:j \in O_i} \exp(\alpha' W_j)}{\sum\limits_{j:j \in O_i} \exp(\alpha^{*\prime}W_j)} \right]
\end{align}

Finally, we log transform the MH acceptance ratio for numerical stability.

\begin{align}
\log MH_\alpha &= \sum_i \left[ \epsilon_\alpha' W_{a_i} + \log\left(\sum\limits_{j:j \in O_i} \exp(\alpha' W_j)\right) - \log\left(\sum\limits_{j:j \in O_i} \exp(\alpha^{*\prime} W_j)\right) \right]
\end{align}

\subsection{Updating countries' parameters, \texorpdfstring{$\boldmath\beta$}{}}

Target distribution:

\begin{align}
p(\bm{\beta}|A, O, \alpha) &= \frac{p(O, A, \alpha, \bm{\beta})}{p(A, O, \alpha)}
\end{align}

We propose a new $\bm{\beta}^*$ using a symmetric proposal distribution that sample $\bm{\beta}^*$ in a box with side length $\epsilon_\beta$

Metropolis-Hasting acceptance ratio:

\begin{align}
MH_\beta = \frac{p(\beta^* | A, O, \alpha)}{p(\beta | A, O, \alpha)} &= \frac{p(A_i | O_i, \alpha)p(O_i|\bm{\beta}^*)p(\bm{\beta}^*|\mu_{\beta}, \tau_{\beta})}{p(A_i | O_i, \alpha)p(O_i|\bm{\beta})p(\bm{\beta}|\mu_{\beta}, \tau_{\beta})} \label{eq:updatebeta_MHratio_simplify} \\
&= \frac{p(O_i|\bm{\beta}^*)p(\bm{\beta}^*|\mu_{\beta}, \tau_{\beta})}{p(O_i|\bm{\beta})p(\bm{\beta}|\mu_{\beta}, \tau_{\beta})} \label{eq:updatebeta_MHratio_final}
\end{align}

where \eqref{eq:updatebeta_MHratio_simplify} is due to the flat prior on $\beta$ and the symmetric proposal distribution.

We plug in \eqref{eq:conditional_probability_of_offer},

\begin{align}
MH_\beta &= \prod_i \left[ \prod\limits_{j \in O_i}\frac{ \exp(\beta_j^{*\prime}X_i)}{ \exp(\beta_j^{\prime}X_i)} \times \prod\limits_{j}\frac{1 + \exp(\beta_j^{*\prime}X_i)}{1 + \exp(\beta_j^{\prime}X_i)} \right] \times \frac{MVN(\bm{\beta}^*|\mu_{\beta}, \tau_{\beta})}{MVN(\bm{\beta}|\mu_{\beta}, \tau_{\beta})} \\
  \log MH_\beta &= \sum_i \left[ \sum_{j \in O_i} \beta_j^{*\prime}X_i - \beta_j^{\prime}X_i + \sum_{j} \log(1 + {\exp({\beta_j^{*\prime}X_i})) - \log(1 +  \exp(\beta_j^{\prime}X_i})) \right] \\
 & + \log MVN(\bm{\beta}^*|\mu_{\beta}, \tau_{\beta}) - \log MVN(\bm{\beta}|\mu_{\beta}, \tau_{\beta}) \nonumber
\end{align}

In the MCMC implementation, since $\bm{\beta}$ is high dimensional, in each
step, we randomly update several $\beta$'s at one time.

\subsection{Update $\mu_{\beta}, \tau_{\beta}$}

Similar to a multivariate normal model, where $\beta$ is the ``data''.

\begin{align}
  p(\mu_{\beta}) &\sim MVN(\mu_0, \Sigma_0) \\
  p(\mu_{\beta} | \beta, \tau_{\beta}) &\sim MVN(m, V) \text{ where } \\
  V &= (\Sigma_0^{-1} + n \tau_{\beta})^{-1} \\
  m &= (\Sigma_0^{-1} + n \tau_{\beta})^{-1} (\Sigma_0^{-1}\mu_0 + n \tau_{\beta} \bar \beta)
\end{align}

